# Project Description
This project provides a REST API that exposes the RAG (Retrieval-Augmented Generation).
Any tool compatible with Ollama or capable of sending HTTP requests can potentially be used to interact with the AI Assistant.

# Diagram
<a href="https://viewer.diagrams.net/?tags=%7B%7D&lightbox=1&highlight=0000ff&edit=_blank&layers=1&nav=1#R%3Cmxfile%3E%3Cdiagram%20name%3D%22Page-1%22%20id%3D%22ADbWfpu-NmmFFpKGbNPW%22%3E7VtZd5s4FP41fowPq6GP3pqmddpM3TOdPvVgo2C1gBghb%2F31I4FYhLBNG8DumT4kQVfSDf7ufiUP9GlwuMdOtHlELvAHmuIeBvpsoGmabev0D6McU4qqKkZK8TB0Oa0gLOEPwIkKp26hC2JhIUHIJzASiWsUhmBNBJqDMdqLy56RL%2F7XyPGARFiuHV%2BmfoYu2aRU21QK%2BhsAvQ3JPx%2BfCZxsMSfEG8dF%2BxJJnw%2F0KUaIpE%2FBYQp8hl6GS7rv9YnZ%2FMUwCEmTDd%2F2j1%2F%2Fem9vP32bPY7e7c0vi%2BD9HRfPzvG3%2FAMPtJFP%2BU1cuGMvTY4cidG%2FW%2Famk2cUkrs4kdOYLlD1iAp7UszTJ4%2F9XTjhGswmGTv6XgnHdJIjkjPXKDgRe3Qd4sQEYfo82W8gAcvIWbOJPdUvStuQwKcjlb8I1xdVz3mW8eAQ7QAm4FAicXzuAQoAwUe6hM8amay4tuojPt4Xos8FvBHFzlWOq5uX8y4kQh%2B4UH5GQKaEFXCphvIhwmSDPBQ6%2FrygTjDahi5gbBU6KtYsEIo4et8AIUcOn7MlSMQWHCD5h20fWiYffuHc2PPsUB4cs0FIP3B5Fxt%2FyTiyQbEvGWUbT0ouRlu8BmfQGXGP4GAPkDPrNO50GHRnFQED3yFwJxp%2F60IdSVb36MCQUhaLR0ncvrOiTvWiOTg%2B9EL6vKYgAkwJTO0hdWRjPrFChKCATsSUBwy9BXgmXACcMuErZgalwYC6tnGVaUL9u8KZMK1Kp%2BgIBh4FZe1DKlBCn%2B6Bg7%2Bqmn2gP8Mo9Lox3dwCuemaVo3pajWma3dluaomSfnjfPmJUsZPD7JR%2BxSwuIHbk%2BQcgn3J9mcDq%2BSMC1dR%2BGfmtvP5kEBy%2FJgoPQrnNau1aTGIqZ2RMQuqJ9iFKDy1F4TuL%2B6MgRcwvShvZMIuLVlv8Y66O2GFyCNxJE8AQypbgJepvgsbRI6pR7mwwZqxlRiA1zSrYNOphBjlEe0KQhfqrovqrjWNVEZn6l6XSpyI8jHFxgepPrBMA9PMjeofm0Fb9vqXjKANBA1TQFB9JSOomTKAo84ANNoAMGTRvh8AbW3YAEJr2CuIcmh9C8gK0%2FAaU%2FLDbN5Wfjultc7906eG%2Be0lpx5HafHyDA8sb%2BvEZVQUviZA2r3GR0uOj8ChKGjKZ7Biv6HLsrobhNJQbgtJ%2B7LnyOMvcxEhEDET64WTAF3MnksAmDUAZLTGSTb%2FD08IsvifK3LF61Rx5cE%2B3VQuiCt8dFM5z4gnAVVGiYzyT%2F2C0s6QpdRnaaeVS7ts6mJppwmlXVHMtV3aZSXbxdpu1FA5%2ByntNDmKL5zQm26SAq8i7kKY6lX6HdWiSbdNyZPVFk2dxW%2FduqpNlHsdQ6uZSahDRbUEmxjaRf%2FjhF0ko7y8eLGx6A1t5cb6ILocuGZovWXlXizpAdVp8pMtjwC6rn%2Bqpha1pgPr0l6J1mXosnVZNclxtqx1uLO05fcp0aoVhq5euUgz1DYg7LNIUy4D2G%2BJZoyum%2Fb8UtbTU9JjaA0duX5Tfjx77ZJVzIMVcJOmmKYE6bFgReh%2F%2BtpNDNiopGiaUtPo67WvbVz5REo4kBra9nkTpoNqmnUFs25ay2SGdCt2LRczM3ZAW9OViQlG3%2FMjck0UXhYRg4PHrgkMn320X2%2BoGQ2DrU%2FgncuTvhPeoJOT3pFgVjWdS9vuMyjKmXDJg5Y6lll%2FceQEDJpwFUeJT1wThOOGzcjfLpM2DOtiFpOfiAipdAvyIge8x6r5NnQXargLnt6hh%2FGdnAb%2BCXjtyPpOrV7CsBo2JdqIeLXCls8U%2FthmSV6VKteoEVe%2FtqlIqF6th5T3WC81kcQGkq4a%2FTaQ6rqt5xxf%2FwlK%2Fduo1xS1KojaaijqO2WoKHalYWjYncn7nBhvuGFY%2F9pyofmEURDJ%2BehL%2FCgGMfzhrBJWDOaInQAlH8WcDEx26YPpRMz9KAu7SfI7RT5ikuHna8%2FQ96ukDpqM1WApZ0ZWr85Xv6rz%2FYnuzq8bT82tw3PrbsV25GJuvPWSuiu5O9XKrYiIW6OSMVzhF%2FHbQ6rFmkILxD4SqN%2FJ8Cu3OYyaCrb2AlgbJWy9fpmSfn0EcYTCGPxvhZR367JbqYqcHNddFenOPV%2F1fFVMmJrmxknClOfDPEG2Ll0q7yFBvq3OfL285b7SEgbQdzAk7C2WtKZfb1q1z%2BuctVr60KqcFdbdAFdqz7raMLfVd%2BX9hzcPi%2BN4fPTeGHD7evJXTZtoHLK3%2FuD7TuAM2NeWgoiqAfNm6RebJFG0c91NQrIG79PgVi5KdXffjQ6LL0Sl96yK75Xp8%2F8A%3C%2Fdiagram%3E%3C%2Fmxfile%3E" target="_blank">
  <img src="./diagram.svg" alt="Diagram">
</a>

# Project Setup

Follow these steps to set up and run the project.

## Prepare local environment

### Configure environment variables

Create .env file in the root directory by copying the .env.localhost file:
```bash
cp .env_localhost .env 
```

Provide your own values in the .env file:
```env
DATASET_DIRECTORY="/path/to/the/dataset/files"
DATABASE_DIRECTORY="/path/to/the/vectore/db/files"
DATABASE_TABLE="TABLE_NAME_OF_YOUR_DB"
```

### Install Ollama
```bash
curl -fsSL https://ollama.com/install.sh | sh
sudo systemctl enable --now ollama
```

### Pull models
```bash
ollama pull hf.co/bartowski/Replete-LLM-V2.5-Qwen-14b-GGUF
ollama pull rjmalagon/gte-qwen2-7b-instruct:f16
```

### Install Dependencies
Install all necessary dependencies using pip:
```bash
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
playwright install
```

## Create the Dataset
Create the dataset:
```bash
make create-dataset
```

## Load Dataset
Load the dataset to vector database:
```bash
make load-dataset
```

## Test RAG
Run the tests for RAG (Retrieval-Augmented Generation):
```bash
make test-rag
```

## Start REST Server
Start the REST server:
```bash
make start-server
```

## Prepare docker environment

### Configure environment variables

Create .env file in the root directory by copying the .env.docker file:
```bash
cp .env_docker .env 
```

### Build docker images
```bash
make compose-build
```

### Start docker images
```bash
make compose-start
```

### Test app
```bash
curl --location 'http://localhost:8000/ask' \
--header 'Content-Type: application/json' \
--data '{"query": "Tell me about security features", "historyKey":"UNIQUE_CONVERSATION_ID_PROVIDED_BY_YOU"}'
```

## Deploy to AWS
Use instance type: g4dn.xlarge

```bash
yum install -y docker
sudo usermod -a -G docker ec2-user
sudo systemctl enable docker --now
sudo curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
```

AWS CDK typescript
```typescript
import {dev} from '../env';
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as ec2 from 'aws-cdk-lib/aws-ec2';
import * as iam from "aws-cdk-lib/aws-iam";

export interface DevAiAssistantProps {
    readonly vpc: ec2.IVpc;
    readonly tags: { key: string, value: string }[];
}

export class DevAiAssistant extends cdk.Stack {
    constructor(scope: Construct, id: string, props: DevAiAssistantProps) {
        super(scope, id, {env: dev});

        // Define the IAM role with ECR access
        const ec2Role = new iam.Role(this, 'EC2ECRRole', {
            assumedBy: new iam.ServicePrincipal('ec2.amazonaws.com'),
        });

        // Attach the necessary ECR policy to the role
        ec2Role.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName('AmazonEC2ContainerRegistryReadOnly'));

        // Reference the specific subnet by ID and availability zone
        const privateSubnet = ec2.Subnet.fromSubnetAttributes(this, 'PrivateSubnet', {
            subnetId: 'subnet-XXX',
            availabilityZone: 'us-east-1a',  // Replace with the correct AZ for your subnet
        });

        // Specify the AMI by its image ID
        const machineImage = ec2.MachineImage.genericLinux({
            'us-east-1': 'ami-XXX',  // Replace with your correct region and AMI ID
        });

        const securityGroup = new ec2.SecurityGroup(this, 'SecurityGroup', {
            vpc: props.vpc,
            allowAllOutbound: true,
        });

        // Since we are in private network, allow all inbound traffic is not a security risk
        securityGroup.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.allTraffic(), 'Allow all inbound traffic');

        // EC2 Instance
        const instance = new ec2.Instance(this, 'ai-assistant', {
            instanceType: new ec2.InstanceType('g4dn.xlarge'),
            machineImage: machineImage, // Change this based on your AMI requirements
            vpc: props.vpc,
            keyName: 'ai_assistent',
            vpcSubnets: {
                subnets: [privateSubnet], // Use the specified private subnet
            },
            role: ec2Role,  // Attach the role to the instance
            securityGroup: securityGroup,
        });

        // User data script to install Docker and Docker Compose
        const userData = ec2.UserData.forLinux();
        userData.addCommands(
            'sudo yum update -y',
            'sudo curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose',
            'sudo chmod +x /usr/local/bin/docker-compose',
        );

        // Add the user data to the instance
        instance.addUserData(userData.render());

        // Apply tags to the instance
        props.tags.forEach(tag => {
            cdk.Tags.of(instance).add(tag.key, tag.value);
        });
    }
}
```
