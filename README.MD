# Project Description

This project provides a REST API that exposes the RAG (Retrieval-Augmented Generation).
Any tool compatible with Ollama or capable of sending HTTP requests can potentially be used to interact with the AI Assistant.

# Diagram

<iframe frameborder="0" style="width:100%;height:583px;" src="https://viewer.diagrams.net/?tags=%7B%7D&lightbox=1&highlight=0000ff&edit=_blank&layers=1&nav=1#R%3Cmxfile%3E%3Cdiagram%20name%3D%22Page-1%22%20id%3D%22ADbWfpu-NmmFFpKGbNPW%22%3E7VtZd5s4FP41fowPq6GP3ppp6%2FRk4pzp5KkHg4KVAcQIeUl%2F%2FUggFiFs0wRj90wf2qAr6Qa%2Bu18pA30a7m%2BxE6%2FvkAeCgaZ4%2B4E%2BG2iaZts6%2FcEorxlFVRUjo%2FgYepxWEpbwB%2BBEhVM30AOJsJAgFBAYi0QXRRFwiUBzMEY7cdkzCsTfGjs%2BkAhL1wlk6jfokXVGtU2lpP8BoL8mxffxmdDJF3NCsnY8tKuQ9PlAn2KESPYU7qcgYOjluGT7Ph6YLV4Mg4i02fCyu%2Fv%2B51d78%2Fgyuxt92ZlPi%2FDrDRfP1gk2%2FIMH2iig%2FCYe3LKXJq8cidG%2FG%2Famk2cUkZskldOYLlD1mAp7Us7TJ5%2F9XDiRC2aTnB19r5RjNskRKZhrFJyYPXoOcRKCMH2e7NaQgGXsuGxiR%2FWL0tYkDOhI5S%2FC9UXVC55VPDhEW4AJ2FdIHJ9bgEJA8CtdwmeNXFZcW%2FURH%2B9K0RcCXoti5yrH1c0veJcSoQ9cKD8jIFPCCnhUQ%2FkQYbJGPoqcYF5SJxhtIg8wtgodlWsWCMUcvRdAyCuHz9kQJGIL9pD8zbYPLZMPnzg39jzbVwev%2BSCiH1zdxcZPOUc2KPelo3zjQcklaINdcASdEfcIDvYBObJO406HQXdUETAIHAK3ovF3LtSRZHV3DowoZbG4k8QdOCvqVE%2BagxNAP6LPLgURYEpgag%2BpIxvziRUiBIV0IqE8YOQvwDPhAuCUCV8xMygNhtS1jetMU%2BpfNc6EaVU2RUcw9CkobgCpQAl9ugUO%2Fq5q9p7%2BG8aRfx7TLSyQm65pNZiu1mC69rksV9UkKT%2FMl4%2BUMr7%2FJBt1QAFLWrg9Sc4R2FVsfzawKs64dBWlf2Zuu5iPCCSvD6nSo2jesFqbloOE2hkZs6B6gF2EokN7QeS9cWcC%2FJDpRXUjE3ZlibvBW%2BruhBUij9SR3AMMqWwBXmb6LmwQOWYe5cQGa8ZWYgA%2B0qyCTWcSYpQ7tC0J51B3XVR3rW2kMs6m7k2pxIEon1BsApDpA8s0MM3cqP6xGbRhr3%2FKCLpA0DAFBNUPMoKaKQM4OhuARhcARiza9wOgrQ1bQGgNewVRDq2fAVlhGl4TSv40m3eV305prXN7%2F9gyvz3l1JM4K16e4Z7lbedwGR9Ej9EQH%2B1ew6Mlh0fgUBA05RtYsf%2Bhx5K6K0RSU68MSvu05yjiL3MRERBBE%2BuFgwidzJ4rAJgNAOS01kk2%2Fw33CLL4n8NvWXW%2FU0eWh%2FtsW7UkrnHSFeU4I54G1BmlUiq%2B%2Bx3FnSHLqc%2FiTqsWd%2FnUyeJOE4q7spzrurjLi7aT1d2opXr2U9xpchxfOJE%2FXaclXk3cpTDVi3Q86mWTbpuSL2ssm84WwXXrojZR7XYMrXYmoQ4V1RJsYmiXHZADdpGOigLj3cait7SVK%2BuE6HLomiF3wwq%2BRNIDqtPkJ5seIfS84FBVLWrNORKFWs5l6LJ1WQ3pcb6sc7jz6u%2FXKdLqNYauXrhMM9QuIOyzTFNOA9hvkWaMLpv2vCnr6SnpMbSWjly%2FKj%2Bev3bFKubhCnhpW0xTwuxgsCb0353tNgZs1FI0TWlo9fXa2TYufCYlHEkNbfu4CdNBPc26gFm3rWVyQ7oWu5aLmRk7om1ozCQEo3%2BKQ3JNFF4eEcO9zy4KDJ8DtHPX1IyG4SYg8MbjSd8Bb3CWs96RYFYNvUvb7jMoyplwxYNWepZ5h3HkhAyaaJXEqU90CcJJy3bkL5dJG4Z1MospzkSEVLoDeZE93mHV%2FBx5CzXahvdf0KfxjZwG%2Fg543cj6Rq1fw7BaNiW6iHiNwpZPFX7bZkVetSrXaBBXv7apSKherIdU9FhPNZHEBpKuGv02kJq6rcccX%2F8JSvPbqJcUtSqI2mop6htlqCh2rWFo2GeT9zExXnHDsPm15ULzHqMwlvPR9%2FhRDBL4w1mlrBjMMTsBSj%2FFnAxMdu2D6UTC%2FSgLu2nyO0UBYpLhJ2zPMAjqpDM0GevBUs6MrF6dr35R5%2FsT3Z23G0%2FDvcNj667FduRibrzx07orvT3Vyb2ImFujkjNc4Xfx20GqxZpCC8Q%2BEqhfyfBrF5iMhgq28QpYFyVss36Zkn49gCRGUQL%2Bt0LSalcMTEVOjpsui5zPPV%2F0fFVMmNrmxmnCVOTDPEG2Tl0r7yFBvq7OfLO85b7SEoYwcDAk7C2WtKZ3153a52XOWi19aNXOCpvugCuNZ11vMDc6LP94J7sRVP4NlD7%2FDw%3D%3D%3C%2Fdiagram%3E%3C%2Fmxfile%3E"></iframe>

# Project Setup

Follow these steps to set up and run the project.

## Prepare local environment

### Configure environment variables

Create .env file in the root directory by copying the .env.localhost file:
```bash
cp .env_localhost .env 
```

Provide your own values in the .env file:
```env
DATASET_DIRECTORY="/path/to/the/dataset/files"
DATABASE_DIRECTORY="/path/to/the/vectore/db/files"
DATABASE_TABLE="TABLE_NAME_OF_YOUR_DB"
```

### Install Ollama
```bash
curl -fsSL https://ollama.com/install.sh | sh
sudo systemctl enable --now ollama
```

### Pull models
```bash
ollama pull hf.co/bartowski/Replete-LLM-V2.5-Qwen-14b-GGUF
ollama pull rjmalagon/gte-qwen2-7b-instruct:f16
```

### Install Dependencies
Install all necessary dependencies using pip:
```bash
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
playwright install
```

## Create the Dataset
Create the dataset:
```bash
make create-dataset
```

## Load Dataset
Load the dataset to vector database:
```bash
make load-dataset
```

## Test RAG
Run the tests for RAG (Retrieval-Augmented Generation):
```bash
make test-rag
```

## Start REST Server
Start the REST server:
```bash
make start-server
```

## Prepare docker environment

### Configure environment variables

Create .env file in the root directory by copying the .env.docker file:
```bash
cp .env_docker .env 
```

### Build docker images
```bash
make compose-build
```

### Start docker images
```bash
make compose-start
```

### Test app
```bash
curl --location 'http://localhost:8000/ask' \
--header 'Content-Type: application/json' \
--data '{"query": "Tell me about security features", "historyKey":"UNIQUE_CONVERSATION_ID_PROVIDED_BY_YOU"}'
```

## Deploy to AWS
Use instance type: g4dn.xlarge

```bash
yum install -y docker
sudo usermod -a -G docker ec2-user
sudo systemctl enable docker --now
sudo curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
```

AWS CDK typescript
```typescript
import {dev} from '../env';
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as ec2 from 'aws-cdk-lib/aws-ec2';
import * as iam from "aws-cdk-lib/aws-iam";

export interface DevAiAssistantProps {
    readonly vpc: ec2.IVpc;
    readonly tags: { key: string, value: string }[];
}

export class DevAiAssistant extends cdk.Stack {
    constructor(scope: Construct, id: string, props: DevAiAssistantProps) {
        super(scope, id, {env: dev});

        // Define the IAM role with ECR access
        const ec2Role = new iam.Role(this, 'EC2ECRRole', {
            assumedBy: new iam.ServicePrincipal('ec2.amazonaws.com'),
        });

        // Attach the necessary ECR policy to the role
        ec2Role.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName('AmazonEC2ContainerRegistryReadOnly'));

        // Reference the specific subnet by ID and availability zone
        const privateSubnet = ec2.Subnet.fromSubnetAttributes(this, 'PrivateSubnet', {
            subnetId: 'subnet-XXX',
            availabilityZone: 'us-east-1a',  // Replace with the correct AZ for your subnet
        });

        // Specify the AMI by its image ID
        const machineImage = ec2.MachineImage.genericLinux({
            'us-east-1': 'ami-XXX',  // Replace with your correct region and AMI ID
        });

        const securityGroup = new ec2.SecurityGroup(this, 'SecurityGroup', {
            vpc: props.vpc,
            allowAllOutbound: true,
        });

        // Since we are in private network, allow all inbound traffic is not a security risk
        securityGroup.addIngressRule(ec2.Peer.anyIpv4(), ec2.Port.allTraffic(), 'Allow all inbound traffic');

        // EC2 Instance
        const instance = new ec2.Instance(this, 'ai-assistant', {
            instanceType: new ec2.InstanceType('g4dn.xlarge'),
            machineImage: machineImage, // Change this based on your AMI requirements
            vpc: props.vpc,
            keyName: 'ai_assistent',
            vpcSubnets: {
                subnets: [privateSubnet], // Use the specified private subnet
            },
            role: ec2Role,  // Attach the role to the instance
            securityGroup: securityGroup,
        });

        // User data script to install Docker and Docker Compose
        const userData = ec2.UserData.forLinux();
        userData.addCommands(
            'sudo yum update -y',
            'sudo curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose',
            'sudo chmod +x /usr/local/bin/docker-compose',
        );

        // Add the user data to the instance
        instance.addUserData(userData.render());

        // Apply tags to the instance
        props.tags.forEach(tag => {
            cdk.Tags.of(instance).add(tag.key, tag.value);
        });
    }
}
```